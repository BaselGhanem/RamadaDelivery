<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramada Delivery | Premium System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-brand: #099999;
            --primary-dark: #077a7a;
            --bg-body: #f4f7f6;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
            --card-hover: 0 10px 25px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: #2c3e50;
            overflow-x: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            background: white;
            min-height: 100vh;
            padding: 30px 20px;
            box-shadow: 5px 0 30px rgba(0,0,0,0.02);
            z-index: 50;
            border-left: 1px solid #eee;
        }

        .brand-logo {
            color: var(--primary-brand);
            font-weight: 800;
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
            border-bottom: 2px dashed #eee;
            padding-bottom: 20px;
        }

        .upload-area-btn {
            background: linear-gradient(135deg, var(--primary-brand), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            font-weight: bold;
            transition: 0.3s;
            box-shadow: 0 5px 15px rgba(9, 153, 153, 0.2);
        }
        .upload-area-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(9, 153, 153, 0.3); }

        /* --- Settings Panel --- */
        .settings-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            animation: fadeIn 0.5s;
        }
        .form-check-input:checked {
            background-color: var(--primary-brand);
            border-color: var(--primary-brand);
        }

        /* --- GRID SYSTEM --- */
        .client-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 10px 0;
        }

        .client-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.04);
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 220px;
        }
        
        .client-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover);
            border-color: rgba(9, 153, 153, 0.2);
        }

        .client-name {
            color: #0d6efd;
            font-weight: 800;
            font-size: 1.3rem;
            margin-bottom: 15px;
            cursor: pointer;
        }
        .client-name:hover { text-decoration: underline; }

        /* Stats Row in Card */
        .card-stats {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .stat-item { text-align: center; }
        .stat-value { font-weight: bold; font-size: 1.1rem; color: #2c3e50; }
        .stat-label { font-size: 0.75rem; color: #6c757d; }
        .stat-value.money { color: var(--primary-brand); }

        .btn-card-download {
            background-color: #28a745; 
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            font-weight: 600;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-card-download:hover { background-color: #218838; color: white; }

        /* --- PDF & Loader --- */
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); z-index: 20000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        #pdf-generation-zone { display: none; }

        .table-responsive {
            background: white; border-radius: 10px; padding: 20px; box-shadow: var(--card-shadow);
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 768px) {
            .sidebar { min-height: auto; padding-bottom: 20px; border-bottom: 1px solid #ddd; }
        }
    </style>
</head>
<body>

    <div id="loader" class="loading-overlay">
        <div class="spinner-border text-success mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h4 class="fw-bold text-dark">جاري المعالجة...</h4>
    </div>

    <div id="pdf-generation-zone" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000; overflow-y: auto; padding: 40px;">
        <div id="pdf-content-wrapper"></div>
    </div>

    <div class="container-fluid">
        <div class="row">
            
            <div class="col-md-3 sidebar">
                <div class="brand-logo">Ramada Delivery</div>
                
                <button class="upload-area-btn mb-3" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i> رفع ملف Excel
                </button>
                <input type="file" id="fileInput" hidden accept=".xlsx, .xls, .csv">

                <div class="card border-0 bg-light p-3 mb-3 rounded-3">
                    <label class="small text-muted fw-bold">سطر العناوين:</label>
                    <input type="number" id="headerRow" class="form-control mb-2" value="1">
                    <label class="small text-muted fw-bold">أسطر الصفحة:</label>
                    <input type="number" id="rowsPerPage" class="form-control" value="14">
                </div>

                <div id="colSelectDiv" style="display: none;" class="settings-panel">
                    <label class="small fw-bold mb-2 text-primary">1. اختر عمود "الاسم":</label>
                    <select id="colSelect" class="form-select mb-2" onchange="showSumOptions()"></select>
                </div>

                <div id="sumConfigDiv" style="display: none;" class="settings-panel">
                    <label class="small fw-bold mb-2 text-primary">2. إعدادات الجمع:</label>
                    
                    <div class="mb-3">
                        <label class="small text-muted d-block mb-1">أعمدة تريد جمعها (للكشف):</label>
                        <div id="checkboxContainer" style="max-height: 150px; overflow-y: auto; background: white; padding: 5px; border: 1px solid #dee2e6; border-radius: 4px;"></div>
                    </div>

                    <div class="mb-3">
                        <label class="small text-muted d-block mb-1">عمود المبلغ الرئيسي (للبطاقة):</label>
                        <select id="primaryAmountSelect" class="form-select form-select-sm"></select>
                    </div>

                    <button class="btn btn-primary w-100 btn-sm" onclick="processData()">
                        <i class="fas fa-check"></i> تطبيق وعرض العملاء
                    </button>
                </div>

            </div>

            <div class="col-md-9 p-4" style="background: #fcfcfc; min-height: 100vh;">
                
                <div id="emptyState" class="text-center mt-5 pt-5">
                    <i class="fas fa-file-invoice-dollar fa-5x text-muted opacity-25 mb-3"></i>
                    <h3 class="text-muted">نظام الكشوفات </h3>
                    <p class="text-muted">الرجاء رفع الملف واختيار الإعدادات من القائمة الجانبية</p>
                </div>

                <div id="gridArea" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <input type="text" id="search" class="form-control w-50" placeholder="بحث عن عميل..." onkeyup="filterGrid()">
                        <h5 class="fw-bold m-0 text-secondary">العملاء: <span id="totalClients">0</span></h5>
                    </div>

                    <div id="cardsContainer" class="client-grid-container"></div>
                </div>

                <div id="previewArea" style="display: none;">
                    <button class="btn btn-outline-secondary mb-3" onclick="backToGrid()">
                        <i class="fas fa-arrow-right"></i> عودة للقائمة
                    </button>
                    
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="fw-bold text-primary" id="previewTitle"></h2>
                        <button class="btn btn-success px-4" onclick="startPDFGeneration()">
                            <i class="fas fa-download"></i> تحميل PDF
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="previewTable">
                            <thead class="table-dark" id="previewThead"></thead>
                            <tbody id="previewTbody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        let excelData = [];
        let headers = [];
        let groupedData = {};
        let currentClient = null;

        // 1. File Upload
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const btn = document.querySelector('.upload-area-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحليل...';

            const reader = new FileReader();
            const headerRow = parseInt(document.getElementById('headerRow').value) - 1;

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                
                excelData = XLSX.utils.sheet_to_json(sheet, {range: headerRow, defval: ""});

                if (excelData.length > 0) {
                    headers = Object.keys(excelData[0]).filter(h => !h.startsWith('__EMPTY'));
                    
                    // Fill Name Dropdown
                    const sel = document.getElementById('colSelect');
                    sel.innerHTML = '<option value="">-- اختر العمود --</option>';
                    headers.forEach(h => sel.innerHTML += `<option value="${h}">${h}</option>`);
                    
                    document.getElementById('colSelectDiv').style.display = 'block';
                    document.getElementById('sumConfigDiv').style.display = 'none'; // Hide step 2 until step 1 is done
                    
                    btn.innerHTML = '<i class="fas fa-check"></i> تم الرفع';
                    setTimeout(() => btn.innerHTML = '<i class="fas fa-upload"></i> رفع ملف Excel', 2000);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // 2. Show Sum Options (Step 2)
        function showSumOptions() {
            const nameCol = document.getElementById('colSelect').value;
            if(!nameCol) return;

            const container = document.getElementById('checkboxContainer');
            const primarySelect = document.getElementById('primaryAmountSelect');
            
            container.innerHTML = '';
            primarySelect.innerHTML = '<option value="">لا يوجد (إخفاء المبلغ)</option>';

            headers.forEach(h => {
                if(h !== nameCol) { // Don't allow summing the name column
                    // Checkbox for PDF Summing
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input sum-checkbox" type="checkbox" value="${h}" id="chk_${h}">
                        <label class="form-check-label small" for="chk_${h}">${h}</label>
                    `;
                    container.appendChild(div);

                    // Option for Primary Amount
                    primarySelect.innerHTML += `<option value="${h}">${h}</option>`;
                }
            });

            document.getElementById('sumConfigDiv').style.display = 'block';
        }

        // 3. Process Data & Render Grid
        function processData() {
            const nameKey = document.getElementById('colSelect').value;
            const primaryAmountKey = document.getElementById('primaryAmountSelect').value;
            
            if (!nameKey) return;

            groupedData = {};
            excelData.forEach(row => {
                const client = row[nameKey];
                if (client) {
                    const safeKey = String(client).trim();
                    if (!groupedData[safeKey]) groupedData[safeKey] = [];
                    groupedData[safeKey].push(row);
                }
            });
            renderGrid(primaryAmountKey);
        }

        // 4. Render Grid with Stats
        function renderGrid(amountKey) {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('gridArea').style.display = 'block';
            
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            
            const clients = Object.keys(groupedData).sort();
            document.getElementById('totalClients').textContent = clients.length;

            clients.forEach(client => {
                const clientRows = groupedData[client];
                const count = clientRows.length;
                
                // Calculate Total for the chosen "Primary Amount" column
                let totalAmount = 0;
                if(amountKey) {
                    clientRows.forEach(row => {
                        let val = parseFloat(row[amountKey]);
                        if(!isNaN(val)) totalAmount += val;
                    });
                }

                const card = document.createElement('div');
                card.className = 'client-card';
                card.setAttribute('data-name', client.toLowerCase());
                
                card.innerHTML = `
                    <div>
                        <div class="client-name" onclick="openPreview('${client}')">${client}</div>
                        
                        <div class="card-stats">
                            <div class="stat-item">
                                <div class="stat-value">${count}</div>
                                <div class="stat-label">عدد الحركات</div>
                            </div>
                            ${amountKey ? `
                            <div class="stat-item" style="border-right: 1px solid #dee2e6;">
                                <div class="stat-value money">${totalAmount.toFixed(2)}</div>
                                <div class="stat-label">إجمالي ${amountKey}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <button class="btn-card-download" onclick="directDownload('${client}')">
                        <i class="fas fa-file-pdf"></i> تحميل الكشف
                    </button>
                `;
                container.appendChild(card);
            });
        }

        // 5. Calculate Totals for SELECTED columns only
        function calculateSelectedTotals(data) {
            // Get all checked boxes
            const checkedBoxes = document.querySelectorAll('.sum-checkbox:checked');
            let totals = {};
            
            // Initialize totals for selected columns
            checkedBoxes.forEach(box => {
                totals[box.value] = 0;
            });

            data.forEach(row => {
                checkedBoxes.forEach(box => {
                    const colName = box.value;
                    let val = parseFloat(row[colName]);
                    if (!isNaN(val)) {
                        totals[colName] += val;
                    }
                });
            });
            return totals;
        }

        function openPreview(client) {
            currentClient = client;
            document.getElementById('gridArea').style.display = 'none';
            document.getElementById('previewArea').style.display = 'block';
            document.getElementById('previewTitle').textContent = client;

            const data = groupedData[client].slice(0, 50); 
            document.getElementById('previewThead').innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            document.getElementById('previewTbody').innerHTML = data.map(row => 
                `<tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>`
            ).join('');
        }

        function backToGrid() {
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('gridArea').style.display = 'block';
        }

        function directDownload(client) {
            currentClient = client;
            startPDFGeneration();
        }

        // 6. PDF Generation (Updated Footer to Fix Overlap)
        function startPDFGeneration() {
            if (!currentClient) return;
            document.getElementById('loader').style.display = 'flex';
            const zone = document.getElementById('pdf-generation-zone');
            const wrapper = document.getElementById('pdf-content-wrapper');
            zone.style.display = 'block';
            wrapper.innerHTML = '';

            const data = groupedData[currentClient];
            const totals = calculateSelectedTotals(data); 
            const rowsPerPage = parseInt(document.getElementById('rowsPerPage').value) || 14;
            const totalPages = Math.ceil(data.length / rowsPerPage);
            const dateStr = new Date().toLocaleDateString('ar-JO');

            let summaryHTML = '';
            const totalKeys = Object.keys(totals);
            if(totalKeys.length > 0) {
                summaryHTML = `
                    <div style="background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:10px; margin-bottom:15px; width:100%; box-sizing:border-box;">
                        <h4 style="margin:0 0 10px 0; color:#099999; font-size:14px; border-bottom:1px solid #eee; padding-bottom:5px;">ملخص مالي:</h4>
                        <div style="display:flex; flex-wrap:wrap; gap:15px;">
                            ${totalKeys.map(key => `
                                <div style="flex:1; min-width:100px; text-align:center; border-left:1px solid #eee;">
                                    <div style="font-size:10px; color:#777;">مجموع ${key}</div>
                                    <div style="font-weight:bold; color:#333; font-size:14px;">${totals[key].toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            const pageStyle = `
                background: white; width: 275mm; min-height: 180mm; margin: 0 auto 30px auto; padding: 15mm; border: 1px solid #eee; position: relative; box-sizing: border-box;
            `;

            for (let i = 0; i < totalPages; i++) {
                const start = i * rowsPerPage;
                const end = start + rowsPerPage;
                const pageData = data.slice(start, end);

                const pageDiv = document.createElement('div');
                pageDiv.style.cssText = pageStyle;
                if (i < totalPages - 1) pageDiv.style.pageBreakAfter = "always";

                pageDiv.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid #099999; padding-bottom:15px; margin-bottom:20px;">
                        <div style="text-align:right;">
                            <h2 style="color:#099999; margin:0; font-weight:bold; font-family:'Tajawal'; font-size:24px;">Ramada Delivery</h2>
                            <p style="margin:5px 0 0; color:#555; font-size:14px;">كشف حساب تفصيلي</p>
                        </div>
                        <div style="text-align:left;">
                            <h3 style="margin:0; font-weight:bold; font-size:20px;">${currentClient}</h3>
                            <p style="margin:5px 0 0; color:#555; font-size:12px;">${dateStr} | صفحة ${i+1}/${totalPages}</p>
                        </div>
                    </div>

                    ${i === 0 ? summaryHTML : ''} 
                    
                    <table style="width:100%; border-collapse:collapse; font-size:11px; text-align:center; direction:rtl;">
                        <thead>
                            <tr style="background:#099999; color:white;">
                                ${headers.map(h => `<th style="padding:8px; border:1px solid #000; font-weight:bold;">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${pageData.map(row => `
                                <tr>${headers.map(h => `<td style="padding:6px; border:1px solid #999;">${row[h] || ''}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                        
                        ${i === totalPages - 1 ? `
                        <tfoot>
                            <tr style="background:#e0fbfb; font-weight:bold; border-top:2px solid #000;">
                                ${headers.map((h, index) => {
                                    if (index === 0) return `<td style="padding:8px; border:1px solid #000;">المجموع الكلي</td>`;
                                    if (totals.hasOwnProperty(h)) {
                                        return `<td style="padding:8px; border:1px solid #000;">${totals[h].toFixed(2)}</td>`;
                                    }
                                    return `<td style="padding:8px; border:1px solid #000;">-</td>`;
                                }).join('')}
                            </tr>
                        </tfoot>
                        ` : ''}
                    </table>

                    <div style="position:absolute; bottom:15px; left:15mm; right:15mm; display:flex; justify-content:space-between; align-items:center; font-size:10px; color:#888; border-top:1px solid #eee; padding-top:8px;">
                        <div style="font-family:sans-serif; font-weight:bold;">Ramada Delivery System</div>
                        <div style="font-weight:bold;">${currentClient}</div>
                    </div>
                `;
                wrapper.appendChild(pageDiv);
            }

            setTimeout(() => {
                html2pdf().set({
                    margin: 0,
                    filename: `كشف_${currentClient}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
                }).from(wrapper).save().then(() => {
                    zone.style.display = 'none';
                    document.getElementById('loader').style.display = 'none';
                });
            }, 1000);
        }

        function filterGrid() {
            const q = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('.client-card').forEach(card => {
                const name = card.getAttribute('data-name');
                card.style.display = name.includes(q) ? 'flex' : 'none';
            });
        }
    </script>
</body>
</html>
